<!DOCTYPE html>
<html>
    <head>
        <title>GEMF FAVITES Online Tool</title>
        <link rel="icon" type="image/x-icon" href="./favicon.ico">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/pyodide/v0.21.3/full/pyodide.js"></script>
        <link rel="stylesheet" href="index.css">
    </head>
    <body>
        <h1 class="my-5">GEMF FAVITES Online Tool</h1>
        <div id="input-container" class="mb-5">
            <div class="d-flex flex-wrap justify-content-center">
                <div class="mb-3 mx-3 file-input">
                    <label for="contactNetwork" class="form-label">Contact Network File *</label>
                    <input onChange="validInput()" type="file" id="contactNetwork" class="form-control fileUpload">
                </div>
                <div class="mx-3 mb-3 file-input">
                    <label for="initialStates" class="form-label">Initial States File *</label>
                    <input onChange="validInput()" type="file" id="initialStates" name="initialStates" class="form-control fileUpload">
                </div>
                <div class="mx-3 mb-3 file-input">
                    <label for="infectedStates" class="form-label">Infected States File *</label>
                    <input onChange="validInput()" type="file" id="infectedStates" name="infectedStates" class="form-control fileUpload">
                </div>
                <div class="mx-3 mb-3 file-input">
                    <label for="rates" class="form-label">Rates File *</label>
                    <input onChange="validInput()" type="file" id="rates" name="rates" class="form-control fileUpload">
                </div>
            </div>
            <div class="mb-3 mx-3">
                <label class="form-label" for="endTime">End Time *</label>
                <div class="input-group number-input">
                    <input onChange="validInput()" id="endTime" type="number" class="form-control" placeholder="End Time" aria-label="End Time">
                </div>
            </div>
            <div class="mb-3 mx-3">
                <label class="form-label" for="endTime">Max Events (Default: 4294967295)</label>
                <div class="input-group number-input">
                    <input onChange="validInput()" id="maxEvents" type="number" class="form-control" placeholder="Max Events" aria-label="Max Events">
                </div>
            </div>
            <div class="mb-3 mx-3">
                <label class="form-label"  for="rngSeed">RNG Seed (Default: None)</label>
                <div class="input-group number-input">
                    <input onChange="validInput()" id="rngSeed" type="number" class="form-control" placeholder="RNG Seed" aria-label="RNG Seed">
                </div>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" value="" id="outputAll">
                <label class="form-check-label" for="outputAll">
                    Output All Transitions? 
                </label>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" value="" id="quiet">
                <label class="form-check-label" for="quiet">
                    Suppress Log Messages?  
                </label>
            </div>
            <p>* Required</p>
        </div>
        <button type="button" class="btn btn-primary" onclick="runGEMFFAVITES()">RUN GEMF_FAVITES</button>
        <br>
        <button type="button" class="btn btn-success" onclick="downloadResults()">Download Results</button>
        <br>
        <div id="text-containers">
            <div id="console-container">
                <h3>Console</h3>
                <textarea id="console" class="form-control container-text"></textarea>
            </div>
            <div id="output-container">
                <h3>Final Results (Output.txt)</h3>
                <textarea id="output" class="form-control container-text"></textarea>
            </div>
        </div>
        <div id="text-containers">
            <div id="console-container">
                <h3>Transmission Network Results</h3>
                <textarea id="transNetwork" class="form-control container-text"></textarea>
            </div>
            <div id="output-container">
                <h3>All Transitions Results</h3>
                <textarea id="allTransitions" class="form-control container-text"></textarea>
            </div>
        </div>

        <script async src="GEMF.js"></script>
        <script>
            const SITE_HOST = window.location.href.includes("https") ? "https://daniel-ji.github.io/GEMF/" : "http://localhost:8000/";
            const PYODIDE_FOLDER = "pyodide";
            // directory for where pyodide writes files 
            const PATH_TO_PYODIDE_ROOT = PYODIDE_FOLDER + "/home/pyodide/";
            let pyodide = undefined;
            let triedToRun = false;
            // ensure GEMF WASM is ready before running
            let GEMFReady = false;
            let runGEMFModule = undefined;
            // output of GEMF
            let output = undefined;
            let allTransitions = undefined;
            let transNetwork = undefined;

            const initializePyodide = async () => {
                pyodide = await loadPyodide({
                    stdout: (text) => {
                        const consoleTxt = document.getElementById("console");
                        consoleTxt.value += "stdout: \t" + text + "\n";
                        console.log(text)
                    },
                    stderr: (text) => {
                        const consoleTxt = document.getElementById("console");
                        consoleTxt.value += "stderr: \t" + text + "\n";
                    }
                });
                // create the folder to mount pyodide to
                FS.mkdir(PYODIDE_FOLDER);
                // mount pyodide
                FS.mount(FS.filesystems.PROXYFS, {
                        root: "/",
                        fs: pyodide.FS
                }, PYODIDE_FOLDER)
            }

            initializePyodide();

            /**
             * Function that runs GEMF_FAVITES.
             * 1. Loads pyodide and mounts its filesystem onto the main FS module.
             * 2. Sets arguments to be passed to GEMF_FAVITES.
             * 3. Writes appropriate files to filesystem. 
             * 4. Runs GEMF_FAVITES, which creates output files to be passed into GEMF.
             * 5. Runs GEMF function.  
             * 
            */
            const runGEMFFAVITES = async () => {
                triedToRun = true;

                if (!validInput()) {
                    return;
                }
                
                if (FS.readdir(PATH_TO_PYODIDE_ROOT).includes("output")) {
                    for (const file of FS.readdir(PATH_TO_PYODIDE_ROOT + "output")) {
                        if (file === "." || file === "..") {
                            continue; 
                        }
                        FS.unlink(PATH_TO_PYODIDE_ROOT + "output/" + file);
                    }
                    FS.rmdir(PATH_TO_PYODIDE_ROOT + "output")
                    FS.unlink("para.txt")
                    FS.unlink("status.txt")
                    FS.unlink("network.txt")
                }

                // sets arguments variable, which will replace sys.argv when running GEMF_FAVITES on the browser
                let arguments = './GEMF_FAVITES.py -c contact_network.tsv -s initial_states.tsv -i infected_states.txt -r rates.tsv -o output';
                // add time argument
                arguments += ' -t ' + document.getElementById("endTime").value;
                // add max events
                const maxEvents = document.getElementById("maxEvents").value;
                if (maxEvents !== '') {
                    arguments += ' --max_events ' + maxEvents; 
                }
                // add rng seed
                const rngSeed = document.getElementById("rngSeed").value;
                if (rngSeed !== '') {
                    arguments += ' --rng_seed ' + rngSeed; 
                }
                // add output all transitions flag
                if (document.getElementById("outputAll").checked) {
                    arguments += ' --output_all_transitions';
                }
                // add quiet flag
                if (document.getElementById("quiet").checked) {
                    arguments += " --quiet";
                }
                pyodide.globals.set("arguments", arguments);
                pyodide.globals.set("runGEMF", runGEMF);

                // creating appropriate files to run GEMF_FAVITES
                writeFile("contactNetwork", "contact_network.tsv", true)();
                writeFile("initialStates", "initial_states.tsv", true)();
                writeFile("infectedStates", "infected_states.txt", true)();
                writeFile("rates", "rates.tsv", true)();
                FS.writeFile('output.txt', '');
                FS.writeFile(PATH_TO_PYODIDE_ROOT + 'GEMF_FAVITES.py', await (await fetch(SITE_HOST + 'GEMF_FAVITES.py')).text(), {encoding: "utf8"});

                // reset text / output
                document.getElementById("console").value = "RUNNING GEMF_FAVITES: \n";
                document.getElementById("output").value = "";
                document.getElementById("transNetwork").value = "";
                document.getElementById("allTransitions").value = "";

                // run GEMF_FAVITES 
                try {
                    pyodide.runPython(await (await fetch(SITE_HOST + "GEMF_FAVITES_WEB.py")).text())

                    if (FS.readdir(PATH_TO_PYODIDE_ROOT + '/output').includes('all_state_transitions.txt')) {
                        allTransitions = new TextDecoder().decode(FS.readFile(PATH_TO_PYODIDE_ROOT + '/output/all_state_transitions.txt'));
                        const allTransitionsArea = document.getElementById("allTransitions");
                        allTransitionsArea.value = allTransitions;
                    }

                    transNetwork = new TextDecoder().decode(FS.readFile(PATH_TO_PYODIDE_ROOT + '/output/transmission_network.txt'));
                    const transNetworkArea = document.getElementById("transNetwork");
                    transNetworkArea.value = transNetwork;
                } catch (e) {
                    console.log(e);
                }

            }

            // global module object from GEMF.js
            Module = {
                // when something is printed to GEMF's stdout
                print: (text) => {
                    const consoleTxt = document.getElementById("console");
                    consoleTxt.value += "stdout: \t" + text + "\n";
                    // on GEMF finish
                    if (text.includes("simulation success!")) {
                        output = new TextDecoder().decode(FS.readFile('output.txt'));
                        const outputArea = document.getElementById("output");
                        outputArea.value = output;
                        FS.writeFile(PATH_TO_PYODIDE_ROOT + "/output/output.txt", output);
                        triedToRun = false;
                    }
                },
                // when something is printed to GEMF's stderr
                printErr: (text) => {
                    const consoleTxt = document.getElementById("console");
                    consoleTxt.value += "stderr: \t" + text + "\n";
                },
                onRuntimeInitialized: () => {
                    GEMFReady = true;
                    runGEMFModule = Module.cwrap('run_gemf', 'number', ['number', 'string']);
                }
            }

            /**
             * Function that runs GEMF.wasm. 
             * 1. Links required files to the corresponding files created by pyodide. 
             * 2. Creates output file. 
             * 3. Clears previous console / output. 
             * 4. Runs GEMF after a delay (ensures that files are all created).
            */
            const runGEMF = () => {
                if (GEMFReady) {
                    try {
                        FS.symlink(PATH_TO_PYODIDE_ROOT + "output/para.txt", "para.txt");
                        FS.symlink(PATH_TO_PYODIDE_ROOT + "output/network.txt", "network.txt");
                        FS.symlink(PATH_TO_PYODIDE_ROOT + "output/status.txt", "status.txt");

                        runGEMFModule(0, "");
                    } catch (err) {
                        console.log(err);
                    }
                }
            }

            const validInput = () => {
                if (!triedToRun) {
                    return;
                }

                let valid = true;
                for (const input of document.getElementsByClassName("fileUpload")) {
                    if (input.value === "") {
                        input.classList.add("border");
                        input.classList.add("border-danger");
                        valid = false;
                    } else {
                        input.classList.remove("border");
                        input.classList.remove("border-danger");
                    }
                }

                const validNumber = (id, required = true) => {
                    const element = document.getElementById(id);
                    if ((element.value === "" && !required) || (element.value !== "" && parseInt(element.value) >= 0)) {
                        element.classList.remove("border");
                        element.classList.remove("border-danger");
                    } else {
                        valid = false;
                        element.classList.add("border");
                        element.classList.add("border-danger");
                    }
                }

                validNumber("endTime");
                validNumber("maxEvents", false);
                validNumber("rngSeed", false);

                return valid;
            }

            // closure function for writing text to files
            const writeFile = (id, fileName, pyodide = false) => {
                return () => {
                    const input = document.getElementById(id).files[0];
                    const reader = new FileReader();
                    reader.onload = function() {
                        FS.writeFile((pyodide ? PATH_TO_PYODIDE_ROOT : '') + fileName, reader.result);
                        // clear so that the reader will run again for new files, even if same name
                        document.getElementById(id).value = "";
                    }
                    reader.readAsText(input);
                }
            }
            
            // handle download results button 
            const downloadResults = () => {
                if (output !== undefined) {
                    download(output, "output.txt");
                    download(transNetwork, "transmission_network.txt");
                    if (allTransitions) {
                        download(allTransitions, "all_state_transitions.txt");
                    }
                } else {
                    alert("GEMF has not been run yet. No output results.");
                }
            }

            // Function to download data to a file
            // from: https://stackoverflow.com/questions/13405129/create-and-save-a-file-with-javascript
            const download = (data, filename, type="text/plain;charset=utf-8") => {
                var file = new Blob([data], {type: type});
                if (window.navigator.msSaveOrOpenBlob) // IE10+
                    window.navigator.msSaveOrOpenBlob(file, filename);
                else { // Others
                    var a = document.createElement("a"),
                            url = URL.createObjectURL(file);
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(function() {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);  
                    }, 0); 
                }
            }
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    </body>
</html>