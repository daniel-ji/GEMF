<!DOCTYPE html>
<html>
    <head>
        <title>GEMF Online Tool</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/pyodide/v0.21.3/full/pyodide.js"></script>
        <link rel="stylesheet" href="index.css">
    </head>
    <body>
        <h1 class="my-5">GEMF Online Tool</h1>
        <div id="input-container">
            <div class="mb-3 mx-3">
                <label for="parameter" class="form-label">Parameter file</label>
                <input type="file" id="parameter" class="form-control">
            </div>
            <div class="mx-3 mb-3">
                <label for="network" class="form-label">Network file</label>
                <input type="file" id="network" name="network" class="form-control">
            </div>
            <div class="mx-3 mb-3">
                <label for="status" class="form-label">Status file</label>
                <input type="file" id="status" name="status" class="form-control">
            </div>
        </div>
        <button type="button" class="btn btn-primary" onclick="runGEMF()">RUN GEMF</button>
        <br>
        <button type="button" class="btn btn-success" onclick="downloadResults()">Download Results</button>
        <br>
        <div id="text-containers">
            <div id="console-container">
                <h3>Console</h3>
                <textarea id="console" class="form-control"></textarea>
            </div>
            <div id="output-container">
                <h3>Final Results (Output.txt)</h3>
                <textarea id="output" class="form-control"></textarea>
            </div>
        </div>
        <script async src="GEMF.js"></script>
        <script>
            const SITE_HOST = "https://daniel-ji.github.io/GEMF/";
            const TEST_HOST = "http://localhost:8000/";
            const PYODIDE_FOLDER = "pyodide";
            const PATH_TO_PYODIDE_ROOT = PYODIDE_FOLDER + "/home/pyodide/";
            let pyodide = undefined;

            const main = async () => {
                const pyWriteFile = async (fileName) => {
                    FS.writeFile(PATH_TO_PYODIDE_ROOT + fileName, await (await fetch(TEST_HOST + fileName)).text(), {encoding: "utf8"});
                }

                pyodide = await loadPyodide();
                FS.mkdir(PYODIDE_FOLDER);
                FS.mount(pyodide.FS.filesystems.PROXYFS, {
                        root: "/",
                        fs: pyodide.FS
                }, PYODIDE_FOLDER)
                pyodide.globals.set("arguments", './GEMF_FAVITES.py -c example/contact_network_complete.tsv -s example/initial_states_seir.tsv -i example/infected_states_seir.txt -r example/rates_seir.tsv -t 100 -o output --gemf_path ../GEMF');
                pyodide.FS.mkdir('example');
                await pyWriteFile("example/contact_network_complete.tsv")
                await pyWriteFile("example/initial_states_seir.tsv")
                await pyWriteFile("example/infected_states_seir.txt")
                await pyWriteFile("example/rates_seir.tsv")
                await pyWriteFile("GEMF_FAVITES.py")
                await pyWriteFile("GEMF");

                try {
                    pyodide.runPython(await (await fetch(TEST_HOST + "GEMF_FAVITES_WEB.py")).text())
                } catch (e) {
                    console.log(e);
                }

                runGEMF();
            }
            main();

            let ready = false;
            let output = undefined;

            // global module object from GEMF.js
            Module = {
                print: (text) => {
                    const consoleTxt = document.getElementById("console");
                    consoleTxt.value += "stdout: \t" + text + "\n";
                    // on finish
                    if (text.includes("simulation success!")) {
                        output = new TextDecoder().decode(FS.readFile('output.txt'));
                        const outputArea = document.getElementById("output");
                        outputArea.value = output;
                    }
                },
                printErr: (text) => {
                    const consoleTxt = document.getElementById("console");
                    consoleTxt.value += "stderr: \t" + text + "\n";
                },
                onRuntimeInitialized: () => {
                    ready = true;
                }
            }

            const runGEMF = () => {
                if (ready) {
                    try {
                        FS.symlink(PATH_TO_PYODIDE_ROOT + "/output/para.txt", "para.txt");
                        FS.symlink(PATH_TO_PYODIDE_ROOT + "/output/network.txt", "network.txt");
                        FS.symlink(PATH_TO_PYODIDE_ROOT + "/output/status.txt", "status.txt");
                        FS.writeFile('output.txt', '');

                        const consoleTxt = document.getElementById("console");
                        const output = document.getElementById("output");
                        consoleTxt.value = "";
                        output.value = "";

                        // TODO: time-based right now, change to callback-based
                        setTimeout(() => {
                            Module.ccall('run_gemf', 'number', ['number', 'string'], [0, ""]);
                        }, 1000);
                    } catch (err) {
                        console.log(err);
                    }
                }
            }

            // closure function for writing text to files
            const writeFile = (id, fileName) => {
                return () => {
                    const input = document.getElementById(id).files[0];
                    const reader = new FileReader();
                    reader.onload = function() {
                        FS.writeFile(fileName, reader.result);
                        // clear so that the reader will run again for new files, even if same name
                        document.getElementById(id).value = "";
                    }
                    reader.readAsText(input);
                }
            }
            
            // handle download results button 
            const downloadResults = () => {
                if (output !== undefined) {
                    download(output, "output.txt");
                } else {
                    alert("GEMF has not been run yet. No output results.");
                }
            }

            // Function to download data to a file
            // from: https://stackoverflow.com/questions/13405129/create-and-save-a-file-with-javascript
            const download = (data, filename, type="text/plain;charset=utf-8") => {
                var file = new Blob([data], {type: type});
                if (window.navigator.msSaveOrOpenBlob) // IE10+
                    window.navigator.msSaveOrOpenBlob(file, filename);
                else { // Others
                    var a = document.createElement("a"),
                            url = URL.createObjectURL(file);
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(function() {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);  
                    }, 0); 
                }
            }
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    </body>
</html>